---
# Source: cardano/templates/topology-updater-pull.yaml
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: RELEASE-NAME-topology-updater-pull
  labels:
    helm.sh/chart: cardano-0.1.3
    app.kubernetes.io/name: cardano
    app.kubernetes.io/instance: RELEASE-NAME
    app.kubernetes.io/version: "1.30.1"
    app.kubernetes.io/managed-by: Helm
  annotations:
spec:
  schedule: "0 0 */1 * *"
  concurrencyPolicy: Replace
  jobTemplate:
    spec:
      template:
        metadata:
          name: RELEASE-NAME-topology-updater-pull
          annotations:
            checksum/updater: 8820b5ab6ef55ae6c577c62119b3984dcd683f0ad635482a42cf5422c9a11642
          labels:
            RELEASE-NAME-redis-client: "true"
            app.kubernetes.io/name: cardano
            app.kubernetes.io/instance: RELEASE-NAME
        spec:
          serviceAccountName: RELEASE-NAME-cardano
          securityContext:
            fsGroup: 1001
          restartPolicy: OnFailure
          initContainers:
            
          
          - name: "wait-for-metrics"
            image: "busybox:1.30.1"
            imagePullPolicy: "IfNotPresent"
            env:
            - name: "READINESS_URL"
              value: http://RELEASE-NAME-cardano-relay-0.RELEASE-NAME-cardano-headless.ixp.svc.cluster.local:12789/metrics
            command: ["sh", "-c", "while true; do echo 'checking EKG readiness'; wget -T 5 --spider $READINESS_URL ; result=$?; if [ $result -eq 0 ]; then echo 'Success: EKG is ready!'; break; fi; echo '...not ready yet; sleeping 3 seconds before retry'; sleep 3; done;"]
          containers:
          - name: pull
            image: "regel/cardano-p2p:v0.0.14"
            imagePullPolicy: IfNotPresent
            resources:
              limits:
                cpu: "10m"
                memory: "64Mi"
            command: ["/bin/sh", "-c", "set -e; bash -x /topologyUpdater.sh -p"]
            env:
            - name: "ENDPOINT"  # Fetch updates from local p2p endpoint
              value: "http://RELEASE-NAME-cardano-p2p.ixp:6001"
            - name: "TOPIC"  # Publish topo updates to Redis
              value: p2p
            - name: "REDIS_HOST"
              value: RELEASE-NAME-redis-master.ixp
            - name: "REDIS_PORT"
              value: "6379"
            - name: "REDISCLI_AUTH"
              valueFrom:
                secretKeyRef:
                  name: RELEASE-NAME-auth
                  key: redis-password
            - name: "REDIS_USER"
              valueFrom:
                secretKeyRef:
                  name: RELEASE-NAME-auth
                  key: redis-username
            - name: "CNODE_PORT"
              valueFrom:
                configMapKeyRef:
                  name: RELEASE-NAME-cardano-configmap-topology-updater
                  key: cardanoNodePort
            - name: "NWMAGIC"
              valueFrom:
                configMapKeyRef:
                  name: RELEASE-NAME-cardano-configmap-topology-updater
                  key: networkMagic
            - name: "IP_VERSION"
              valueFrom:
                configMapKeyRef:
                  name: RELEASE-NAME-cardano-configmap-topology-updater
                  key: ipVersion
            - name: "MAX_PEERS"
              valueFrom:
                configMapKeyRef:
                  name: RELEASE-NAME-cardano-configmap-topology-updater
                  key: maxPeers
            - name: "CUSTOM_PEERS"
              valueFrom:
                configMapKeyRef:
                  name: RELEASE-NAME-cardano-configmap-topology-updater
                  key: customPeers
            - name: "EKG_HOST"
              valueFrom:
                configMapKeyRef:
                  name: RELEASE-NAME-cardano-configmap-topology-updater
                  key: ekgHost
            - name: "EKG_PORT"
              valueFrom:
                configMapKeyRef:
                  name: RELEASE-NAME-cardano-configmap-topology-updater
                  key: ekgPort
            - name: "EKG_TIMEOUT"
              valueFrom:
                configMapKeyRef:
                  name: RELEASE-NAME-cardano-configmap-topology-updater
                  key: ekgTimeout
